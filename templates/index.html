<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Watch Party ‚Äì Stable Build</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:"Segoe UI",sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;display:flex;flex-direction:column}
  .header{background:rgba(0,0,0,.3);color:#fff;text-align:center;padding:20px}
  .connection-status{display:inline-block;padding:5px 12px;border-radius:20px;font-size:12px;margin-top:8px;font-weight:700}
  .connected{background:#10b981}.disconnected{background:#ef4444}
  .main-container{display:flex;flex:1;padding:20px;gap:20px;max-width:1800px;margin:0 auto;width:100%}
  .video-section{flex:2;display:flex;flex-direction:column;gap:20px}
  .movie-player{background:#000;border-radius:12px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.3)}
  video{width:100%;display:block}
  .video-chat-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px}
  .video-chat-box{background:rgba(0,0,0,.5);border-radius:12px;overflow:hidden;position:relative;aspect-ratio:4/3;box-shadow:0 5px 20px rgba(0,0,0,.3)}
  .video-label{position:absolute;bottom:10px;left:10px;background:rgba(0,0,0,.7);color:#fff;padding:5px 10px;border-radius:4px;font-size:12px}
  .sidebar{flex:1;min-width:300px;display:flex;flex-direction:column;gap:20px}
  .debug{background:#fff;border-radius:10px;padding:12px;max-height:600px;overflow:auto;font-family:monospace;font-size:11px}
  .controls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .btn{padding:10px 16px;background:#667eea;color:#fff;border-radius:6px;cursor:pointer;border:none;font-size:14px}
  .btn.warn{background:#dc3545}.btn.orange{background:#ff9800}
  .input{padding:10px;border-radius:6px;border:2px solid rgba(102,126,234,.3);font-size:14px}
</style>
</head>
<body>
<div class="header">
  <h1>üé¨ Watch Party</h1>
  <p>Open this in two browsers/devices to test</p>
  <div id="connectionStatus" class="connection-status disconnected">‚óè Disconnected</div>
</div>

<div class="main-container">
  <div class="video-section">
    <div class="movie-player">
      <video id="moviePlayer" controls crossorigin="anonymous"></video>
      <div style="padding:12px;background:rgba(0,0,0,.9);display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" onclick="syncPlay()">‚ñ∂ Play</button>
        <button class="btn" onclick="syncPause()">‚è∏ Pause</button>
        <input id="videoUrl" class="input" style="flex:1;min-width:200px" placeholder="Enter direct .mp4 URL">
        <button class="btn" onclick="loadVideo()">Load</button>
      </div>
    </div>

    <div class="video-chat-container">
      <div class="video-chat-box">
        <video id="localVideo" autoplay muted playsinline></video>
        <div class="video-label">You</div>
      </div>
      <div class="video-chat-box">
        <video id="remoteVideo" autoplay playsinline></video>
        <div id="remotePlaceholder" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:48px;color:#fff">üë§</div>
        <div class="video-label">Friend</div>
      </div>
    </div>

    <div class="controls">
      <input id="username" class="input" placeholder="Your Name" style="width:150px">
      <input id="roomCode" class="input" placeholder="Room code" style="width:150px">
      <button class="btn" id="joinRoomBtn" onclick="joinRoom()">Join/Create Room</button>
      <button class="btn" id="startCameraBtn" onclick="startCamera()" style="display:none">Start Camera</button>
      <button class="btn warn" id="stopCameraBtn" onclick="stopCamera()" style="display:none">Stop</button>
      <button class="btn orange" onclick="forceRenegotiate()">üîÑ Reconnect</button>
    </div>
  </div>

  <div class="sidebar">
    <div id="debugLog" class="debug"></div>
    <button class="btn" onclick="downloadLogs()">Download Logs</button>
  </div>
</div>

<script>
/* ========== LOG UTILITIES ========== */
const logBuf=[];function dbg(...a){const s='['+new Date().toLocaleTimeString()+'] '+a.map(x=>typeof x==='object'?JSON.stringify(x):x).join(' ');logBuf.push(s);const el=document.getElementById('debugLog');if(el){el.innerText=logBuf.slice(-300).join('\n');el.scrollTop=el.scrollHeight;}console.log(...a);}
function downloadLogs(){const blob=new Blob([logBuf.join('\n')],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='watchparty-logs.txt';a.click();}
function updateConnectionStatus(ok){const el=document.getElementById('connectionStatus');el.className='connection-status '+(ok?'connected':'disconnected');el.textContent=ok?'‚óè Connected':'‚óè Disconnected';}

/* ========== GLOBALS ========== */
let socket,peer,localStream,remoteStream,remoteSid,currentRoom,username;
let makingOffer=false,polite=false;
const pendingIce=[];
const config={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};

/* ========== SOCKET SETUP ========== */
function initSocket(){
 socket=io({transports:['websocket']});
 socket.on('connect',()=>{dbg('socket connected',socket.id);updateConnectionStatus(true);});
 socket.on('disconnect',()=>updateConnectionStatus(false));

 socket.on('room_joined',d=>{dbg('room joined',d);currentRoom=d.room_code;
   document.getElementById('startCameraBtn').style.display='inline-block';
   document.getElementById('joinRoomBtn').disabled=true;});

 socket.on('user_joined',d=>{
   if(d.sid===socket.id)return;
   remoteSid=d.sid;dbg('user joined',d);
   if(localStream){createPeer(remoteSid,true);}
   else dbg('start camera first');
 });

 socket.on('user_left',()=>{cleanupPeer();});

 socket.on('webrtc_offer',async d=>{
   dbg('offer recv',d.sender_sid);
   polite=socket.id>d.sender_sid;
   if(!peer) await createPeer(d.sender_sid,false);
   await peer.setRemoteDescription(d.offer);
   const answer=await peer.createAnswer();
   await peer.setLocalDescription(answer);
   socket.emit('webrtc_answer',{room_code:currentRoom,target_sid:d.sender_sid,answer});
 });

 socket.on('webrtc_answer',async d=>{
   dbg('answer recv');
   if(peer) await peer.setRemoteDescription(d.answer);
 });

 socket.on('webrtc_ice_candidate',async d=>{
   if(!d.candidate)return;
   if(peer && peer.remoteDescription) await peer.addIceCandidate(d.candidate);
   else pendingIce.push(d.candidate);
 });

 socket.on('video_play',d=>{const v=document.getElementById('moviePlayer');v.currentTime=d.time;v.play();});
 socket.on('video_pause',d=>{const v=document.getElementById('moviePlayer');v.currentTime=d.time;v.pause();});
 socket.on('video_load',d=>{const v=document.getElementById('moviePlayer');v.src=d.url;v.load();});
}

/* ========== PEER CONNECTION ========== */
async function createPeer(targetSid,initiator){
 if(peer){peer.close();}
 peer=new RTCPeerConnection(config);
 remoteStream=new MediaStream();
 document.getElementById('remoteVideo').srcObject=remoteStream;

 localStream?.getTracks().forEach(t=>peer.addTrack(t,localStream));
 peer.ontrack=e=>{remoteStream.addTrack(e.track);document.getElementById('remotePlaceholder').style.display='none';};

 peer.onicecandidate=e=>{
   if(e.candidate) socket.emit('webrtc_ice_candidate',{room_code:currentRoom,target_sid:targetSid,candidate:e.candidate});
 };

 peer.onconnectionstatechange=()=>dbg('pc state',peer.connectionState);

 if(initiator){
   const offer=await peer.createOffer({offerToReceiveAudio:true,offerToReceiveVideo:true});
   await peer.setLocalDescription(offer);
   socket.emit('webrtc_offer',{room_code:currentRoom,target_sid:targetSid,offer});
 }
 pendingIce.splice(0).forEach(c=>peer.addIceCandidate(c));
}

/* ========== CAMERA CONTROL ========== */
async function startCamera(){
 try{
  dbg('getUserMedia');
  localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  const v=document.getElementById('localVideo');
  v.srcObject=localStream;v.muted=true;v.play();
  document.getElementById('startCameraBtn').style.display='none';
  document.getElementById('stopCameraBtn').style.display='inline-block';
  if(remoteSid) createPeer(remoteSid,true);
 }catch(e){alert('Camera error:'+e.message);}
}

function stopCamera(){localStream?.getTracks().forEach(t=>t.stop());localStream=null;
 document.getElementById('localVideo').srcObject=null;
 document.getElementById('startCameraBtn').style.display='inline-block';
 document.getElementById('stopCameraBtn').style.display='none';
 cleanupPeer();
}

/* ========== VIDEO SYNC ========== */
function loadVideo(){const url=document.getElementById('videoUrl').value;if(!url||!currentRoom)return alert('Join room first');
 socket.emit('video_load',{room_code:currentRoom,url,username});document.getElementById('moviePlayer').src=url;}
function syncPlay(){const v=document.getElementById('moviePlayer');socket.emit('video_play',{room_code:currentRoom,time:v.currentTime});v.play();}
function syncPause(){const v=document.getElementById('moviePlayer');socket.emit('video_pause',{room_code:currentRoom,time:v.currentTime});v.pause();}

/* ========== ROOM & RECONNECT ========== */
function joinRoom(){
 const name=document.getElementById('username').value.trim()||'User'+Math.floor(Math.random()*9000);
 const rc=document.getElementById('roomCode').value.trim()||('ROOM-'+Math.random().toString(36).slice(2,8).toUpperCase());
 username=name;
 socket.emit('join_room',{room_code:rc,username:name});
}
function forceRenegotiate(){if(remoteSid && localStream){createPeer(remoteSid,true);}else alert('Start camera first');}
function cleanupPeer(){if(peer){peer.close();peer=null;}document.getElementById('remoteVideo').srcObject=null;document.getElementById('remotePlaceholder').style.display='flex';}

/* ========== STARTUP ========== */
window.addEventListener('load',()=>{initSocket();setTimeout(()=>{document.getElementById('username').value='User'+Math.floor(Math.random()*9000);},200);});
</script>
</body>
</html>
